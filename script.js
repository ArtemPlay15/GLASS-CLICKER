// --- GAME STATE ---
let count = 0;
let multiplier = 1;
let achievements = [];
let nextUpgradeCost = 50;
let activePet = null;
let ownedPets = [];
let ownedSkins = [];
let activeSkin = null;
let wheelLastSpin = 0;

// --- PETS DATA ---
const pets = [
  {
    id: 1, name: "–ö–æ—Ç–∏–∫", avatar: "üê±",
    desc: "+1 –∫–ª–∏–∫/—Å–µ–∫", price: 300, level: 1, maxLevel: 5,
    bonus: pet => { return { type: "autoclick", value: pet.level }; }
  },
  {
    id: 2, name: "–î—Ä–æ–Ω", avatar: "ü§ñ",
    desc: "+5% –∫ –∫–∞–∂–¥–æ–º—É –∫–ª–∏–∫—É", price: 700, level: 1, maxLevel: 5,
    bonus: pet => { return { type: "clickboost", value: 0.05 * pet.level }; }
  }
];

// --- SKINS DATA ---
const skins = [
  { id: 1, name: "–ó–≤—ë–∑–¥–Ω–∞—è –∫–Ω–æ–ø–∫–∞", demo: "‚≠ê", desc: "–ö–Ω–æ–ø–∫–∞ —Å–æ –∑–≤–µ–∑–¥–æ–π", price: 200, type: "button" },
  { id: 2, name: "–ö–æ—Å–º–æ—Å", demo: "üåå", desc: "–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π —Ñ–æ–Ω", price: 400, type: "background" }
];

// --- ACHIEVEMENTS ---
const achievementList = [
  { clicks: 10, text: "–î–µ—Å—è—Ç–∫–∞!" },
  { clicks: 50, text: "–ü–æ–ª—Ç–∏–Ω–Ω–∏–∫!" },
  { clicks: 100, text: "–°–æ—Ç–Ω—è!" },
  { clicks: 500, text: "–ü–æ–ª—Ç—ã—Å—è—á–∏!" },
  { clicks: 1000, text: "–¢—ã—Å—è—á–∞! –£–†–ê!" }
];

// --- DOM ---
const counterElem = document.getElementById("counter");
const clickerBtn = document.getElementById("clicker");
const clickLabel = document.getElementById("click-label");
const multiplierElem = document.getElementById("multiplier");
const upgradeBtn = document.getElementById("upgrade");
const achievementsPanel = document.getElementById("achievements");
const themeToggleBtn = document.getElementById("theme-toggle");
const petsListElem = document.getElementById("pets-list");
const skinsListElem = document.getElementById("skins-list");
const tabBtns = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');
const wheelBtn = document.getElementById("spin-btn");
const wheelResultElem = document.getElementById("wheel-result");
const wheelCooldownElem = document.getElementById("wheel-cooldown");

// --- GAME LOGIC ---

function updateCounter() {
  counterElem.textContent = count;
}

function animateCounter() {
  counterElem.style.background = getComputedStyle(document.body).getPropertyValue('--count-bg-active');
  counterElem.style.transform = "scale(1.13)";
  setTimeout(() => {
    counterElem.style.background = getComputedStyle(document.body).getPropertyValue('--count-bg');
    counterElem.style.transform = "scale(1)";
  }, 130);
}

function checkUpgrade() {
  upgradeBtn.disabled = count < nextUpgradeCost;
  upgradeBtn.textContent = "–£–ª—É—á—à–∏—Ç—å (" + nextUpgradeCost + ")";
}

upgradeBtn.onclick = () => {
  if (count >= nextUpgradeCost) {
    count -= nextUpgradeCost;
    multiplier++;
    multiplierElem.textContent = "x" + multiplier;
    updateCounter();
    checkUpgrade();
    showAchievement("–ú–Ω–æ–∂–∏—Ç–µ–ª—å x" + multiplier + "!");
    nextUpgradeCost = 50 + (multiplier - 1) * 30;
    checkUpgrade();
  }
};

clickerBtn.onclick = () => {
  let bonus = getClickBonus();
  count += Math.floor(multiplier * bonus);
  updateCounter();
  checkUpgrade();
  checkAchievements();
  animateCounter();
};

function getClickBonus() {
  let bonus = 1;
  ownedPets.forEach(pid => {
    let pet = pets.find(p => p.id === pid.id);
    if (pet && pid.active) {
      let b = pet.bonus(pid);
      if (b.type === "clickboost") bonus += b.value;
    }
  });
  return bonus;
}

function autoClickLoop() {
  let autoclick = 0;
  ownedPets.forEach(pid => {
    let pet = pets.find(p => p.id === pid.id);
    if (pet && pid.active) {
      let b = pet.bonus(pid);
      if (b.type === "autoclick") autoclick += b.value;
    }
  });
  if (autoclick > 0) {
    count += autoclick;
    updateCounter();
    checkUpgrade();
    checkAchievements();
  }
  setTimeout(autoClickLoop, 1000);
}
autoClickLoop();

function checkAchievements() {
  achievementList.forEach(a => {
    if (count >= a.clicks && !achievements.includes(a.clicks)) {
      showAchievement(a.text);
      achievements.push(a.clicks);
    }
  });
}

function showAchievement(text) {
  const el = document.createElement("div");
  el.className = "achievement";
  el.textContent = "‚ú® " + text;
  achievementsPanel.appendChild(el);
  setTimeout(() => { el.remove(); }, 3500);
}

// --- –ü–∏—Ç–æ–º—Ü—ã ---
function renderPets() {
  petsListElem.innerHTML = "";
  pets.forEach(pet => {
    let owned = ownedPets.find(p => p.id === pet.id);
    const card = document.createElement("div");
    card.className = "pet-card";
    card.innerHTML = `
      <span class="pet-avatar">${pet.avatar}</span>
      <div class="pet-desc">
        <b>${pet.name}</b> <span class="pet-lvl">–£—Ä. ${owned ? owned.level : 1}</span><br>
        <span>${pet.desc}</span>
      </div>
    `;
    const btn = document.createElement("button");
    btn.className = "glass-btn mini pet-btn";
    if (!owned) {
      btn.textContent = `–ö—É–ø–∏—Ç—å (${pet.price})`;
      btn.onclick = () => buyPet(pet.id);
      btn.disabled = count < pet.price;
    } else if (!owned.active) {
      btn.textContent = "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å";
      btn.onclick = () => activatePet(pet.id);
    } else if (owned.level < pet.maxLevel) {
      btn.textContent = `–ü—Ä–æ–∫–∞—á–∞—Ç—å (${pet.price * (owned.level + 1)})`;
      btn.onclick = () => upgradePet(pet.id);
      btn.disabled = count < pet.price * (owned.level + 1);
    } else {
      btn.textContent = "–ú–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å";
      btn.disabled = true;
    }
    card.appendChild(btn);
    petsListElem.appendChild(card);
  });
}
function buyPet(id) {
  let pet = pets.find(p => p.id === id);
  if (count >= pet.price) {
    count -= pet.price;
    ownedPets.push({ id: pet.id, level: 1, active: false });
    showAchievement(`–¢—ã –∫—É–ø–∏–ª –ø–∏—Ç–æ–º—Ü–∞: ${pet.name}!`);
    renderPets();
    updateCounter();
    saveGame();
  }
}
function activatePet(id) {
  ownedPets.forEach(p => p.active = false);
  let pet = ownedPets.find(p => p.id === id);
  if (pet) pet.active = true;
  renderPets();
  saveGame();
}
function upgradePet(id) {
  let pet = pets.find(p => p.id === id);
  let owned = ownedPets.find(p => p.id === id);
  let price = pet.price * (owned.level + 1);
  if (owned && owned.level < pet.maxLevel && count >= price) {
    count -= price;
    owned.level++;
    showAchievement(`–ü–∏—Ç–æ–º–µ—Ü ${pet.name} —Ç–µ–ø–µ—Ä—å —É—Ä. ${owned.level}!`);
    renderPets();
    updateCounter();
    saveGame();
  }
}

// --- –°–∫–∏–Ω—ã ---
function renderSkins() {
  skinsListElem.innerHTML = "";
  skins.forEach(skin => {
    let owned = ownedSkins.includes(skin.id);
    const card = document.createElement("div");
    card.className = "skin-card";
    card.innerHTML = `
      <span class="skin-demo">${skin.demo}</span>
      <div class="skin-desc">
        <b>${skin.name}</b><br><span>${skin.desc}</span>
      </div>
    `;
    const btn = document.createElement("button");
    btn.className = "glass-btn mini skin-btn";
    if (!owned) {
      btn.textContent = `–ö—É–ø–∏—Ç—å (${skin.price})`;
      btn.onclick = () => buySkin(skin.id);
      btn.disabled = count < skin.price;
    } else if (activeSkin === skin.id) {
      btn.textContent = "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è";
      btn.disabled = true;
    } else {
      btn.textContent = "–í—ã–±—Ä–∞—Ç—å";
      btn.onclick = () => selectSkin(skin.id);
    }
    card.appendChild(btn);
    skinsListElem.appendChild(card);
  });
}
function buySkin(id) {
  let skin = skins.find(s => s.id === id);
  if (count >= skin.price) {
    count -= skin.price;
    ownedSkins.push(skin.id);
    showAchievement(`–û—Ç–∫—Ä—ã—Ç —Å–∫–∏–Ω: ${skin.name}`);
    renderSkins();
    updateCounter();
    saveGame();
  }
}
function selectSkin(id) {
  activeSkin = id;
  applySkin();
  renderSkins();
  saveGame();
}
function applySkin() {
  if (activeSkin === 1) { // –ö–Ω–æ–ø–∫–∞ —Å–æ –∑–≤–µ–∑–¥–æ–π
    clickLabel.textContent = "‚≠ê –ö–ª–∏–∫! ‚≠ê";
  } else {
    clickLabel.textContent = "–ö–ª–∏–∫!";
  }
  if (activeSkin === 2) { // –ö–æ—Å–º–∏—á–µ—Å–∫–∏–π —Ñ–æ–Ω
    document.querySelector(".main-bg").style.background = "linear-gradient(135deg, #212245 0%, #4b006e 100%)";
  } else {
    document.querySelector(".main-bg").style.background = "";
  }
}

// --- –ö–æ–ª–µ—Å–æ —É–¥–∞—á–∏ ---
function canSpinWheel() {
  const DAY = 1000 * 60 * 60 * 24;
  return Date.now() - wheelLastSpin >= DAY;
}
function updateWheelCooldown() {
  if (canSpinWheel()) {
    wheelCooldownElem.textContent = "";
    wheelBtn.disabled = false;
  } else {
    let left = 24 * 60 * 60 * 1000 - (Date.now() - wheelLastSpin);
    let h = Math.floor(left / (1000 * 60 * 60));
    let m = Math.floor((left % (1000 * 60 * 60)) / (1000 * 60));
    let s = Math.floor((left % (1000 * 60)) / 1000);
    wheelCooldownElem.textContent = `–î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑: ${h}—á ${m}–º ${s}—Å`;
    wheelBtn.disabled = true;
    setTimeout(updateWheelCooldown, 1000);
  }
}
wheelBtn.onclick = spinWheel;
function spinWheel() {
  if (!canSpinWheel()) return;
  const prizes = [
    { type: "clicks", value: 100, text: "+100 –∫–ª–∏–∫–æ–≤!" },
    { type: "clicks", value: 300, text: "+300 –∫–ª–∏–∫–æ–≤!" },
    { type: "skin", value: 1, text: "–°–∫–∏–Ω: –ó–≤—ë–∑–¥–Ω–∞—è –∫–Ω–æ–ø–∫–∞!" },
    { type: "pet", value: 2, text: "–ü–∏—Ç–æ–º–µ—Ü: –î—Ä–æ–Ω!" }
  ];
  const prize = prizes[Math.floor(Math.random() * prizes.length)];
  if (prize.type === "clicks") {
    count += prize.value;
    updateCounter();
    wheelResultElem.textContent = `üéÅ ${prize.text}`;
  }
  if (prize.type === "skin" && !ownedSkins.includes(prize.value)) {
    ownedSkins.push(prize.value);
    renderSkins();
    wheelResultElem.textContent = `üéÅ ${prize.text}`;
  }
  if (prize.type === "pet" && !ownedPets.some(p => p.id === prize.value)) {
    ownedPets.push({ id: prize.value, level: 1, active: false });
    renderPets();
    wheelResultElem.textContent = `üéÅ ${prize.text}`;
  }
  wheelLastSpin = Date.now();
  updateWheelCooldown();
  saveGame();
}

// --- –¢–ê–ë–´ ---
tabBtns.forEach(btn => {
  btn.onclick = function() {
    tabBtns.forEach(b => b.classList.remove("active"));
    tabContents.forEach(tab => tab.classList.remove("show"));
    this.classList.add("active");
    document.getElementById('tab-' + this.dataset.tab).classList.add("show");
    if (this.dataset.tab === "pets") renderPets();
    if (this.dataset.tab === "skins") renderSkins();
    if (this.dataset.tab === "minigame") {
      updateWheelCooldown();
      wheelResultElem.textContent = "";
    }
  }
});

// --- –¢–ï–ú–ê ---
function applyTheme(theme) {
  if (theme === 'dark') {
    document.body.classList.add('dark'); themeToggleBtn.textContent = '‚òÄÔ∏è';
  } else {
    document.body.classList.remove('dark'); themeToggleBtn.textContent = 'üåô';
  }
  localStorage.setItem('clickerTheme', theme);
}
function initTheme() {
  let theme = localStorage.getItem('clickerTheme');
  if (!theme) {
    const h = new Date().getHours();
    theme = (h >= 21 || h < 8) ? 'dark' : 'light';
  }
  applyTheme(theme);
}
themeToggleBtn.onclick = () => {
  const isDark = document.body.classList.contains('dark');
  applyTheme(isDark ? 'light' : 'dark');
};

// --- –°–û–•–†–ê–ù–ï–ù–ò–ï ---
function saveGame() {
  localStorage.glassClicker3 = JSON.stringify({
    count, multiplier, achievements, nextUpgradeCost,
    ownedPets, ownedSkins, activeSkin, wheelLastSpin
  });
}
function loadGame() {
  if (localStorage.glassClicker3) {
    try {
      const save = JSON.parse(localStorage.glassClicker3);
      count = save.count || 0;
      multiplier = save.multiplier || 1;
      achievements = save.achievements || [];
      nextUpgradeCost = save.nextUpgradeCost || 50 + (multiplier - 1) * 30;
      ownedPets = save.ownedPets || [];
      ownedSkins = save.ownedSkins || [];
      activeSkin = save.activeSkin || null;
      wheelLastSpin = save.wheelLastSpin || 0;
      multiplierElem.textContent = "x" + multiplier;
      updateCounter(); checkUpgrade(); applySkin();
    } catch {}
  }
}
window.onload = () => {
  initTheme();
  loadGame();
  renderPets();
  renderSkins();
  updateWheelCooldown();
};
window.onbeforeunload = saveGame;

// --- –ö–ª–∞–≤–∏—à–∞ –ø—Ä–æ–±–µ–ª
window.addEventListener("keydown", e => {
  if (e.code === "Space" && document.getElementById("tab-main").classList.contains("show")) {
    clickerBtn.click();
  }
});

// --- –≠—Ñ—Ñ–µ–∫—Ç—ã –∫–Ω–æ–ø–∫–∏
clickerBtn.addEventListener("click", function(e) {
  this.classList.remove("ring");
  void this.offsetWidth; // reflow
  this.classList.add("ring");
  setTimeout(() => this.classList.remove("ring"), 330);
});

// --- –°—Ç–∞—Ä—Ç–æ–≤—ã–µ –≤—ã–∑–æ–≤—ã
updateCounter(); checkUpgrade();